<template page>
  <l-m src="@pui/button/button.html"></l-m>
  <style>
    :host {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      border: #aaa solid 1px;
      display: flex;
      --item-padding-top: 0;
      --item-padding-bottom: 0;
      border-radius: 8px;
    }
    .container > div {
      padding: 8px 0 0 8px;
      max-width: 30vw;
      border-right: #aaa solid 1px;
    }
    .container > div:last-child {
      border-right: none;
    }
    iconify-icon {
      font-size: 18px;
    }

    p-list {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
  <h2>确认要压缩混淆的文件</h2>
  <x-if :value="loadingUgFile">
    <p>项目扫描中。。。</p>
  </x-if>
  <x-else>
    <div>
      <!-- Total File:{{total}} <br /> -->
      <div class="container">
        <div>
          <div>Component File:{{comps.length}}</div>
          <p-list>
            <x-fill :value="comps">
              <p-list-item>
                <iconify-icon
                  icon="iconamoon:component"
                  slot="prefix"
                ></iconify-icon>
                {{$data}}</p-list-item
              >
            </x-fill>
          </p-list>
        </div>
        <div>
          <div>Page File:{{pages.length}}</div>
          <p-list>
            <x-fill :value="pages">
              <p-list-item>
                <iconify-icon
                  icon="icon-park-outline:page"
                  slot="prefix"
                ></iconify-icon>
                {{$data}}
              </p-list-item>
            </x-fill>
          </p-list>
        </div>
        <div>
          <div>javascript File:{{jss.length}}</div>
          <p-list>
            <x-fill :value="jss">
              <p-list-item>
                <iconify-icon
                  icon="tabler:brand-javascript"
                  slot="prefix"
                ></iconify-icon>
                {{$data}}
              </p-list-item>
            </x-fill>
          </p-list>
        </div>
      </div>
    </div>
  </x-else>
  <div style="text-align: center">
    <p-button on:click="clickNext" style="width: 200px; margin-top: 16px"
      >下一步</p-button
    >
  </div>
  <script>
    export default async ({ load }) => {
      // load(`https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`);
      // const terser = await load(
      //   `https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`
      // );

      // const result = await Terser.minify(
      //   "function add(aaaa, bbbbb) { return aaaa + bbbbb; }"
      // );
      // console.log(result);

      return {
        data: {
          total: 0,
          compCount: 0,
          pageCount: 0,
          jsCount: 0,
          comps: [],
          pages: [],
          jss: [],
          _target: null, // 目标文件夹
          loadingUgFile: true,
          _handles: {},
        },
        proto: {
          clickNext() {
            this.emit("next", {
              bubbles: false,
              data: {
                handles: this._handles,
                comps: this.comps.toJSON(),
                pages: this.pages.toJSON(),
                jss: this.jss.toJSON(),
              },
            });
          },
          async reloadFolder() {
            this.loadingUgFile = true;

            const handles = new Map();

            const { list, total, comps, pages, jss } = await getList(
              this._target,
              async (opt) => {
                if (/\.html$/.test(opt.name)) {
                  const content = await opt.handle.text();
                  const temp = $(`<template>${content}</template>`);

                  const isComp = !!temp.$("template[component]");

                  if (isComp) {
                    opt.isComp = true;
                    handles.set(opt.handle.path, opt.handle);
                    return;
                  }

                  const isPage = !!temp.$("template[page]");

                  if (isPage) {
                    opt.isPage = true;
                    handles.set(opt.handle.path, opt.handle);
                  }
                } else if (/\.js$/.test(opt.name)) {
                  opt.isJs = true;
                  handles.set(opt.handle.path, opt.handle);
                }
              }
            );

            this._handles = handles;

            this.comps = comps;
            this.pages = pages;
            this.jss = jss;
            this.total = total;

            // console.log("list:", list, total, comps, pages, jss);
            this.loadingUgFile = false;

            setTimeout(() => {
              this.shadow.$("p-button").ele.click();
            }, 100);
          },
        },
      };
    };

    const getList = async (parHandle, callback) => {
      const list = [];
      let count = 0;
      const comps = [];
      const pages = [];
      const jss = [];
      for await (let [name, handle] of parHandle.entries()) {
        if (name === "node_modules") {
          continue;
        }

        const opt = {
          name,
          kind: handle.kind,
          handle,
        };

        if (opt.kind === "directory") {
          const result = await getList(handle, callback);
          count += result.total;
          comps.push(...result.comps);
          pages.push(...result.pages);
          jss.push(...result.jss);

          opt.childs = result.list;
        } else {
          count++;
          await callback(opt);
          if (opt.isComp) {
            comps.push(handle.path);
          } else if (opt.isPage) {
            pages.push(handle.path);
          } else if (opt.isJs) {
            jss.push(handle.path);
          }
        }

        list.push(opt);
      }

      return {
        list,
        total: count,
        comps,
        pages,
        jss,
      };
    };
  </script>
</template>
