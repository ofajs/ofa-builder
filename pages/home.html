<template page>
  <l-m src="@pui/button/button-group.html"></l-m>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/list/list.html"></l-m>

  <style>
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 0 16px;
    }
    .hide {
      display: none !important;
    }
    iconify-icon {
      font-size: 18px;
    }
  </style>

  <div class="container" class:hide="!canuse">
    <p-button-group style="margin-top: 100px">
      <p-button :variant="step === 0 ? 'contained' : 'outlined'">
        选择项目
      </p-button>
      <p-button :variant="step === 1 ? 'contained' : 'outlined'">
        确认文件
      </p-button>
      <p-button :variant="step === 2 ? 'contained' : 'outlined'">
        配置
      </p-button>
      <p-button :variant="step === 3 ? 'contained' : 'outlined'">
        完成
      </p-button>
    </p-button-group>

    <x-if :value="step === 0">
      <h1>ofa.js项目混淆器</h1>
      <p-button on:click="selectDir">选择你本地的 ofa.js 项目</p-button>
      <p>
        不用担心上传到服务器，因为这个应用没有服务端，是直接在浏览器上完成所有操作！！
      </p>
    </x-if>
    <o-page
      id="confirm-page"
      src="./confirm.html"
      class:hide="step !== 1"
    ></o-page>
  </div>

  <div class="container" class:hide="!!canuse">
    <h2>
      你的浏览器暂时不支持该应用，请使用最新的 Chrome 浏览器来访问这个应用；
    </h2>
    <p>
      因为这个工具是通过 File Access API
      访问你本地文件夹进行混淆的，你当前的浏览器不支持这个API。
    </p>
  </div>
  <script>
    export default async ({ load }) => {
      load(`https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`);
      // const { open, get } = await load(
      //   "https://cdn.jsdelivr.net/gh/kirakiray/NoneOS@1.3.1/core/fs/main.js"
      // );
      const { open, get } = await load("http://localhost:5559/core/fs/main.js");
      // const terser = await load(
      //   `https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`
      // );

      // const result = await Terser.minify(
      //   "function add(aaaa, bbbbb) { return aaaa + bbbbb; }"
      // );
      // console.log(result);

      return {
        data: {
          canuse: !!window.showDirectoryPicker,
          step: 0,
          _target: null, // 目标文件夹
          loadingUgFile: true,
        },
        proto: {
          async selectDir() {
            this._target = await open();
            this.shadow.$("#confirm-page")._target = this._target;
            this.step++;
            this.shadow.$("#confirm-page").reloadFolder();
          },
        },
        async attached() {
          const testFolder = await get("Punch-UI");
          this._target = testFolder;
          this.shadow.$("#confirm-page")._target = testFolder;
          this.step++;
          this.shadow.$("#confirm-page").reloadFolder();
        },
      };
    };
  </script>
</template>
