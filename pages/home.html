<template page>
  <l-m src="@pui/button/button-group.html"></l-m>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/list/list.html"></l-m>

  <style>
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 0 16px;
    }
    .hide {
      display: none !important;
    }
  </style>

  <div class="container" class:hide="!canuse">
    <p-button-group style="margin-top: 100px">
      <p-button :variant="step === 0 ? 'contained' : 'outlined'">
        选择项目
      </p-button>
      <p-button :variant="step === 1 ? 'contained' : 'outlined'">
        选择文件
      </p-button>
      <p-button :variant="step === 2 ? 'contained' : 'outlined'">
        配置
      </p-button>
      <p-button :variant="step === 3 ? 'contained' : 'outlined'">
        完成
      </p-button>
    </p-button-group>

    <x-if :value="step === 0">
      <h1>ofa.js项目混淆器</h1>
      <p-button on:click="selectDir">选择你本地的 ofa.js 项目</p-button>
      <p>
        不用担心上传到服务器，因为这个应用没有服务端，是直接在浏览器上完成所有操作！！
      </p>
    </x-if>
    <x-else-if :value="step === 1">
      <h2>请选择要压缩混淆的文件</h2>
      <x-if :value="loadingUgFile">
        <p>项目扫描中。。。</p>
      </x-if>
      <x-else>
        <div>
          Total File:{{s1Data.total}} <br />
          <div
            style="
              display: flex;
              --item-padding-top: 0;
              --item-padding-bottom: 0;
            "
          >
            <div>
              <div>Component File:{{s1Data.comps.length}}</div>
              <p-list style="max-height: 300px; overflow-y: auto">
                <x-fill :value="s1Data.comps">
                  <p-list-item>{{$data}}</p-list-item>
                </x-fill>
              </p-list>
            </div>
            <div>
              <div>Page File:{{s1Data.pages.length}}</div>
              <p-list style="max-height: 300px; overflow-y: auto">
                <x-fill :value="s1Data.pages">
                  <p-list-item>{{$data}}</p-list-item>
                </x-fill>
              </p-list>
            </div>
            <div>
              <div>javascript File:{{s1Data.jss.length}}</div>
              <p-list style="max-height: 300px; overflow-y: auto">
                <x-fill :value="s1Data.jss">
                  <p-list-item>{{$data}}</p-list-item>
                </x-fill>
              </p-list>
            </div>
          </div>
        </div>
      </x-else>
    </x-else-if>
  </div>

  <div class="container" class:hide="!!canuse">
    <h2>
      你的浏览器暂时不支持该应用，请使用最新的 Chrome 浏览器来访问这个应用；
    </h2>
    <p>
      因为这个工具是通过 File Access API
      访问你本地文件夹进行混淆的，你当前的浏览器不支持这个API。
    </p>
  </div>
  <script>
    export default async ({ load }) => {
      load(`https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`);
      // const { open, get } = await load(
      //   "https://cdn.jsdelivr.net/gh/kirakiray/NoneOS@1.3.1/core/fs/main.js"
      // );
      const { open, get } = await load("http://localhost:5559/core/fs/main.js");
      // const terser = await load(
      //   `https://cdn.jsdelivr.net/npm/terser@5.27.0/dist/bundle.min.js`
      // );

      // const result = await Terser.minify(
      //   "function add(aaaa, bbbbb) { return aaaa + bbbbb; }"
      // );
      // console.log(result);

      return {
        data: {
          canuse: !!window.showDirectoryPicker,
          step: 0,
          _target: null, // 目标文件夹
          loadingUgFile: true,
          s1Data: {
            total: 0,
            compCount: 0,
            pageCount: 0,
            jsCount: 0,
            comps: [],
            pages: [],
            jss: [],
          },
        },
        watch: {
          step(val) {
            switch (val) {
              case 1:
                this.reloadFolder();
                break;
            }
          },
        },
        proto: {
          async selectDir() {
            this._target = await open();
            this.step++;
          },
          async reloadFolder() {
            this.loadingUgFile = true;

            const { list, total, comps, pages, jss } = await getList(
              this._target,
              async (opt) => {
                if (/\.html$/.test(opt.name)) {
                  const content = await opt.handle.text();
                  const temp = $(`<template>${content}</template>`);

                  const isComp = !!temp.$("template[component]");

                  if (isComp) {
                    opt.isComp = true;
                    return;
                  }

                  const isPage = !!temp.$("template[page]");

                  if (isPage) {
                    opt.isPage = true;
                  }
                } else if (/\.js$/.test(opt.name)) {
                  opt.isJs = true;
                }
              }
            );

            this.s1Data.comps = comps;
            this.s1Data.pages = pages;
            this.s1Data.jss = jss;
            this.s1Data.total = total;

            console.log("list:", list, total, comps, pages, jss);
            this.loadingUgFile = false;
          },
        },
        async ready() {
          // const testFolder = await get("Punch-UI");
          // this._target = testFolder; // test
          // this.step++;
        },
      };
    };

    const getList = async (parHandle, callback) => {
      const list = [];
      let count = 0;
      const comps = [];
      const pages = [];
      const jss = [];
      for await (let [name, handle] of parHandle.entries()) {
        if (name === "node_modules") {
          continue;
        }

        const opt = {
          name,
          kind: handle.kind,
          handle,
        };

        if (opt.kind === "directory") {
          const result = await getList(handle, callback);
          count += result.total;
          comps.push(...result.comps);
          pages.push(...result.pages);
          jss.push(...result.jss);

          opt.childs = result.list;
        } else {
          count++;
          await callback(opt);
          if (opt.isComp) {
            comps.push(handle.path);
          } else if (opt.isPage) {
            pages.push(handle.path);
          } else if (opt.isJs) {
            jss.push(handle.path);
          }
        }

        list.push(opt);
      }

      return {
        list,
        total: count,
        comps,
        pages,
        jss,
      };
    };
  </script>
</template>
